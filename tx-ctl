#!/bin/bash
#================================================================
# 超流量保护系统 - 管理工具
# Traffic Limit Protection System - Control Tool
# Version: 1.0.0
#================================================================

# 配置文件路径
CONFIG_FILE="/etc/tx-monitor.conf"
LOG_FILE="/var/log/tx-monitor.log"
AUDIT_LOG="/var/log/tx-monitor-audit.log"
ENABLE_FLAG="/run/tx-monitor.enabled"
SOFT_BLOCK_FLAG="/run/tx-monitor.soft-block"
HARD_BLOCK_FLAG="/run/tx-monitor.hard-block"
MONITOR_SCRIPT="/usr/local/bin/tx-monitor.sh"
IPTABLES_CHAIN="TX_MONITOR_BLOCK"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

#================================================================
# 工具函数
#================================================================

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[✗]${NC} $1"
}

print_header() {
    echo ""
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""
}

check_root() {
    if [ "$EUID" -ne 0 ]; then 
        print_error "请使用 root 权限运行此命令"
        echo "使用: sudo tx-ctl $1"
        exit 1
    fi
}

load_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        print_error "配置文件不存在: $CONFIG_FILE"
        exit 1
    fi
    source "$CONFIG_FILE"
}

audit_log() {
    local action="$1"
    local details="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ACTION=$action | DETAILS=$details | USER=$(whoami)" >> "$AUDIT_LOG"
}

#================================================================
# 启用监控
#================================================================

cmd_enable() {
    check_root "enable"
    load_config
    
    if [ -f "$ENABLE_FLAG" ]; then
        print_warning "监控已经启用"
        return
    fi
    
    print_info "启用流量监控..."
    touch "$ENABLE_FLAG"
    audit_log "ENABLE" "Traffic monitoring enabled"
    
    print_success "流量监控已启用"
    print_info "监控网卡: $INTERFACE"
    print_info "流量阈值: ${THRESHOLD_MB} MB"
    print_info "检查间隔: ${CHECK_INTERVAL} 分钟"
    
    # 立即执行一次检查
    if [ -f "$MONITOR_SCRIPT" ]; then
        print_info "执行初始检查..."
        bash "$MONITOR_SCRIPT"
        print_success "初始检查完成"
    fi
}

#================================================================
# 禁用监控
#================================================================

cmd_disable() {
    check_root "disable"
    
    if [ ! -f "$ENABLE_FLAG" ]; then
        print_warning "监控已经禁用"
        return
    fi
    
    print_info "禁用流量监控..."
    rm -f "$ENABLE_FLAG"
    audit_log "DISABLE" "Traffic monitoring disabled"
    
    print_success "流量监控已禁用"
    print_warning "注意: 现有的防火墙规则不会自动清除"
    print_info "如需清除阻断规则，请运行: tx-ctl unblock"
}

#================================================================
# 查看状态
#================================================================

cmd_status() {
    load_config
    
    print_header "超流量保护系统 - 状态报告"
    
    # 启用状态
    if [ -f "$ENABLE_FLAG" ]; then
        echo -e "${GREEN}● 监控状态:${NC} 已启用"
    else
        echo -e "${YELLOW}● 监控状态:${NC} 已禁用"
    fi
    
    # 配置信息
    echo -e "${CYAN}● 监控网卡:${NC} $INTERFACE"
    echo -e "${CYAN}● 流量阈值:${NC} ${THRESHOLD_MB} MB"
    echo -e "${CYAN}● 检查间隔:${NC} ${CHECK_INTERVAL} 分钟"
    
    # 获取当前流量
    if command -v vnstat &> /dev/null; then
        TX_BYTES=$(vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '.interfaces[0].traffic.month[0].tx' 2>/dev/null)
        
        if [ -n "$TX_BYTES" ] && [[ "$TX_BYTES" =~ ^[0-9]+$ ]]; then
            TX_MB=$(( TX_BYTES / 1000000 ))
            USAGE_PCT=$(( TX_MB * 100 / THRESHOLD_MB ))
            
            # 根据使用率显示不同颜色
            if [ "$USAGE_PCT" -ge 100 ]; then
                COLOR=$RED
            elif [ "$USAGE_PCT" -ge 90 ]; then
                COLOR=$YELLOW
            else
                COLOR=$GREEN
            fi
            
            echo -e "${COLOR}● 当前流量:${NC} ${TX_MB} MB / ${THRESHOLD_MB} MB (${USAGE_PCT}%)"
            
            # 显示进度条
            BAR_LENGTH=40
            FILLED_LENGTH=$(( USAGE_PCT * BAR_LENGTH / 100 ))
            if [ "$FILLED_LENGTH" -gt "$BAR_LENGTH" ]; then
                FILLED_LENGTH=$BAR_LENGTH
            fi
            
            BAR="["
            for i in $(seq 1 $FILLED_LENGTH); do BAR="${BAR}█"; done
            for i in $(seq $FILLED_LENGTH $((BAR_LENGTH - 1))); do BAR="${BAR}░"; done
            BAR="${BAR}]"
            
            echo -e "  ${COLOR}$BAR${NC} ${USAGE_PCT}%"
        else
            echo -e "${YELLOW}● 当前流量:${NC} 数据不可用"
        fi
    else
        echo -e "${YELLOW}● 当前流量:${NC} vnstat 未安装"
    fi
    
    # 阻断状态
    echo ""
    if [ -f "$HARD_BLOCK_FLAG" ]; then
        echo -e "${RED}● 阻断状态:${NC} 硬阻断 (HARD BLOCK) - 网卡已禁用或所有流量已阻断"
    elif [ -f "$SOFT_BLOCK_FLAG" ]; then
        echo -e "${YELLOW}● 阻断状态:${NC} 软阻断 (SOFT BLOCK) - 非必要端口已阻断"
    else
        echo -e "${GREEN}● 阻断状态:${NC} 正常运行"
    fi
    
    # 防火墙规则
    if iptables -L "$IPTABLES_CHAIN" -n &>/dev/null; then
        RULE_COUNT=$(iptables -L "$IPTABLES_CHAIN" -n | grep -c "^[A-Z]")
        echo -e "${CYAN}● 防火墙规则:${NC} ${RULE_COUNT} 条规则激活"
    else
        echo -e "${CYAN}● 防火墙规则:${NC} 无激活规则"
    fi
    
    # 响应配置
    echo ""
    echo -e "${CYAN}● 响应配置:${NC}"
    echo "  - ${WARNING_LEVEL_2}% 时: $ACTION_AT_90"
    echo "  - ${WARNING_LEVEL_3}% 时: $ACTION_AT_95"
    echo "  - 100% 时: $ACTION_AT_100"
    
    # 最后检查时间
    if [ -f "$LOG_FILE" ]; then
        LAST_CHECK=$(tail -n 1 "$LOG_FILE" | grep -oP '^\[\K[^\]]+')
        if [ -n "$LAST_CHECK" ]; then
            echo -e "${CYAN}● 最后检查:${NC} $LAST_CHECK"
        fi
    fi
    
    echo ""
}

#================================================================
# 解除阻断
#================================================================

cmd_unblock() {
    check_root "unblock"
    load_config
    
    print_header "解除流量阻断"
    
    # 清除防火墙规则
    if iptables -L "$IPTABLES_CHAIN" -n &>/dev/null; then
        print_info "清除防火墙规则..."
        iptables -D OUTPUT -o "$INTERFACE" -j "$IPTABLES_CHAIN" 2>/dev/null || true
        iptables -F "$IPTABLES_CHAIN" 2>/dev/null || true
        iptables -X "$IPTABLES_CHAIN" 2>/dev/null || true
        print_success "防火墙规则已清除"
    fi
    
    # 重置 OUTPUT 链策略
    if iptables -L OUTPUT -n | grep -q "policy DROP"; then
        print_info "重置 OUTPUT 链策略..."
        iptables -P OUTPUT ACCEPT
        print_success "OUTPUT 链策略已重置"
    fi
    
    # 重新启用网卡
    if ! ip link show "$INTERFACE" | grep -q "state UP"; then
        print_info "重新启用网卡 $INTERFACE..."
        ip link set "$INTERFACE" up
        print_success "网卡已重新启用"
    fi
    
    # 清除标记文件
    rm -f "$SOFT_BLOCK_FLAG" "$HARD_BLOCK_FLAG"
    
    audit_log "UNBLOCK" "All traffic blocks removed"
    
    print_success "所有阻断已解除"
    print_warning "监控仍然启用，如流量继续超限，阻断会再次触发"
    print_info "如需完全禁用监控，请运行: tx-ctl disable"
}

#================================================================
# 查看日志
#================================================================

cmd_logs() {
    local lines="${1:-50}"
    
    if [ ! -f "$LOG_FILE" ]; then
        print_warning "日志文件不存在"
        return
    fi
    
    print_header "流量监控日志 (最近 $lines 行)"
    tail -n "$lines" "$LOG_FILE"
}

#================================================================
# 强制检查
#================================================================

cmd_force_check() {
    check_root "force-check"
    
    if [ ! -f "$MONITOR_SCRIPT" ]; then
        print_error "监控脚本不存在: $MONITOR_SCRIPT"
        exit 1
    fi
    
    print_info "执行强制检查..."
    bash "$MONITOR_SCRIPT"
    print_success "检查完成"
}

#================================================================
# 测试运行
#================================================================

cmd_test() {
    check_root "test"
    load_config
    
    print_header "测试模式运行"
    
    # 获取当前流量
    if ! command -v vnstat &> /dev/null; then
        print_error "vnstat 未安装"
        exit 1
    fi
    
    TX_BYTES=$(vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '.interfaces[0].traffic.month[0].tx' 2>/dev/null)
    
    if [ -z "$TX_BYTES" ] || ! [[ "$TX_BYTES" =~ ^[0-9]+$ ]]; then
        print_error "无法获取流量数据"
        exit 1
    fi
    
    TX_MB=$(( TX_BYTES / 1000000 ))
    USAGE_PCT=$(( TX_MB * 100 / THRESHOLD_MB ))
    
    print_info "当前流量: ${TX_MB} MB / ${THRESHOLD_MB} MB (${USAGE_PCT}%)"
    
    echo ""
    print_info "预计响应动作:"
    
    if [ "$USAGE_PCT" -ge 100 ]; then
        echo "  ⚠️  100%: $ACTION_AT_100"
    fi
    
    if [ "$USAGE_PCT" -ge "${WARNING_LEVEL_3}" ]; then
        echo "  ⚠️  ${WARNING_LEVEL_3}%: $ACTION_AT_95"
    fi
    
    if [ "$USAGE_PCT" -ge "${WARNING_LEVEL_2}" ]; then
        echo "  ⚠️  ${WARNING_LEVEL_2}%: $ACTION_AT_90"
    fi
    
    if [ "$USAGE_PCT" -ge "${WARNING_LEVEL_1}" ]; then
        echo "  ℹ️  ${WARNING_LEVEL_1}%: 警告日志"
    fi
    
    if [ "$USAGE_PCT" -lt "${WARNING_LEVEL_1}" ]; then
        print_success "流量正常，无需响应"
    fi
    
    echo ""
    print_info "这是测试运行，不会执行实际动作"
}

#================================================================
# 重置统计
#================================================================

cmd_reset() {
    check_root "reset"
    load_config
    
    print_warning "重置月度流量统计将清除 vnstat 数据"
    echo -n "确认重置? (yes/no): "
    read -r confirm
    
    if [ "$confirm" != "yes" ]; then
        print_info "已取消"
        return
    fi
    
    print_info "重置流量统计..."
    vnstat -i "$INTERFACE" --remove
    vnstat -i "$INTERFACE" --add
    
    audit_log "RESET" "Traffic statistics reset for $INTERFACE"
    
    print_success "统计已重置"
}

#================================================================
# 快速设置阈值
#================================================================

cmd_set_threshold() {
    check_root "set-threshold"
    
    local new_threshold=$1
    
    if [ -z "$new_threshold" ] || ! [[ "$new_threshold" =~ ^[0-9]+$ ]]; then
        print_error "无效的阈值，请提供数字 (MB)"
        echo "使用: tx-ctl set-threshold <MB>"
        exit 1
    fi
    
    load_config
    
    print_info "当前阈值: ${THRESHOLD_MB} MB"
    print_info "新阈值: ${new_threshold} MB"
    
    # 修改配置文件
    sed -i "s/^THRESHOLD_MB=.*/THRESHOLD_MB=$new_threshold/" "$CONFIG_FILE"
    
    audit_log "SET_THRESHOLD" "Changed from ${THRESHOLD_MB}MB to ${new_threshold}MB"
    
    print_success "阈值已更新"
}

#================================================================
# 显示防火墙规则
#================================================================

cmd_rules_show() {
    load_config
    
    print_header "当前防火墙规则"
    
    if iptables -L "$IPTABLES_CHAIN" -n &>/dev/null; then
        echo "自定义链: $IPTABLES_CHAIN"
        echo ""
        iptables -L "$IPTABLES_CHAIN" -n -v --line-numbers
    else
        print_info "无激活的流量监控规则"
    fi
    
    echo ""
    echo "OUTPUT 链策略:"
    iptables -L OUTPUT -n | head -n 1
}

#================================================================
# 清除防火墙规则
#================================================================

cmd_rules_clear() {
    check_root "rules clear"
    cmd_unblock
}

#================================================================
# 重新配置
#================================================================

cmd_config() {
    check_root "config"
    
    if [ ! -f "$CONFIG_FILE" ]; then
        print_error "配置文件不存在"
        exit 1
    fi
    
    print_header "编辑配置文件"
    print_info "配置文件: $CONFIG_FILE"
    
    # 使用默认编辑器
    ${EDITOR:-nano} "$CONFIG_FILE"
    
    audit_log "CONFIG_EDIT" "Configuration file edited"
    
    print_success "配置已更新"
    print_warning "更改将在下次检查时生效"
}

#================================================================
# 流量统计功能
#================================================================

cmd_stats() {
    local stats_type="${1:-summary}"
    
    load_config
    
    if ! command -v vnstat &> /dev/null; then
        print_error "vnstat 未安装"
        exit 1
    fi
    
    case "$stats_type" in
        summary|"")
            cmd_stats_summary
            ;;
        daily|day|d)
            cmd_stats_daily
            ;;
        monthly|month|m)
            cmd_stats_monthly
            ;;
        hourly|hour|h)
            cmd_stats_hourly
            ;;
        detail|full)
            cmd_stats_detail
            ;;
        export)
            cmd_stats_export
            ;;
        *)
            print_error "未知的统计类型: $stats_type"
            echo "可用类型: summary, daily, monthly, hourly, detail, export"
            exit 1
            ;;
    esac
}

cmd_stats_summary() {
    print_header "流量统计概览 - $INTERFACE"
    
    # 获取JSON数据
    local json_data=$(vnstat -i "$INTERFACE" --json 2>/dev/null)
    
    if [ -z "$json_data" ]; then
        print_error "无法获取流量数据"
        return 1
    fi
    
    # 本月流量
    local month_rx=$(echo "$json_data" | jq -r '.interfaces[0].traffic.month[0].rx // 0' 2>/dev/null)
    local month_tx=$(echo "$json_data" | jq -r '.interfaces[0].traffic.month[0].tx // 0' 2>/dev/null)
    local month_total=$((month_rx + month_tx))
    
    # 转换为 MB
    local month_rx_mb=$((month_rx / 1000000))
    local month_tx_mb=$((month_tx / 1000000))
    local month_total_mb=$((month_total / 1000000))
    
    # 今日流量
    local day_rx=$(echo "$json_data" | jq -r '.interfaces[0].traffic.day[0].rx // 0' 2>/dev/null)
    local day_tx=$(echo "$json_data" | jq -r '.interfaces[0].traffic.day[0].tx // 0' 2>/dev/null)
    local day_total=$((day_rx + day_tx))
    
    local day_rx_mb=$((day_rx / 1000000))
    local day_tx_mb=$((day_tx / 1000000))
    local day_total_mb=$((day_total / 1000000))
    
    # 显示统计
    echo -e "${CYAN}本月流量统计 ($(date +%Y年%m月)):${NC}"
    printf "  %-12s %10s MB (%6.2f GB)\n" "流入 (RX):" "$month_rx_mb" "$(echo "scale=2; $month_rx_mb/1024" | bc)"
    printf "  %-12s %10s MB (%6.2f GB)\n" "流出 (TX):" "$month_tx_mb" "$(echo "scale=2; $month_tx_mb/1024" | bc)"
    printf "  %-12s %10s MB (%6.2f GB)\n" "总计:" "$month_total_mb" "$(echo "scale=2; $month_total_mb/1024" | bc)"
    
    echo ""
    echo -e "${CYAN}今日流量统计 ($(date +%Y-%m-%d)):${NC}"
    printf "  %-12s %10s MB (%6.2f GB)\n" "流入 (RX):" "$day_rx_mb" "$(echo "scale=2; $day_rx_mb/1024" | bc)"
    printf "  %-12s %10s MB (%6.2f GB)\n" "流出 (TX):" "$day_tx_mb" "$(echo "scale=2; $day_tx_mb/1024" | bc)"
    printf "  %-12s %10s MB (%6.2f GB)\n" "总计:" "$day_total_mb" "$(echo "scale=2; $day_total_mb/1024" | bc)"
    
    # 流出流量使用率 (仅统计流出)
    if [ -n "$THRESHOLD_MB" ] && [ "$THRESHOLD_MB" -gt 0 ]; then
        echo ""
        local usage_pct=$((month_tx_mb * 100 / THRESHOLD_MB))
        local color=$GREEN
        [ "$usage_pct" -ge 90 ] && color=$RED
        [ "$usage_pct" -ge 80 ] && [ "$usage_pct" -lt 90 ] && color=$YELLOW
        
        echo -e "${CYAN}流出流量使用率:${NC}"
        printf "  ${color}%s MB / %s MB (%s%%)${NC}\n" "$month_tx_mb" "$THRESHOLD_MB" "$usage_pct"
        
        # 进度条
        local bar_length=40
        local filled=$((usage_pct * bar_length / 100))
        [ "$filled" -gt "$bar_length" ] && filled=$bar_length
        
        local bar="["
        for i in $(seq 1 $filled); do bar="${bar}█"; done
        for i in $(seq $filled $((bar_length - 1))); do bar="${bar}░"; done
        bar="${bar}]"
        echo -e "  ${color}$bar${NC} ${usage_pct}%"
        
        # 预计月底流量
        local days_in_month=$(date -d "$(date +%Y-%m-01) +1 month -1 day" +%d)
        local current_day=$(date +%d)
        if [ "$current_day" -gt 0 ]; then
            local estimated=$((month_tx_mb * days_in_month / current_day))
            echo ""
            printf "  ${YELLOW}预计月底流出: ~%s MB (%6.2f GB)${NC}\n" "$estimated" "$(echo "scale=2; $estimated/1024" | bc)"
        fi
    fi
    
    echo ""
}

cmd_stats_daily() {
    print_header "每日流量统计 - $INTERFACE"
    
    printf "%-12s %12s %12s %12s\n" "日期" "流入(MB)" "流出(MB)" "总计(MB)"
    echo "────────────────────────────────────────────────────"
    
    vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '
        .interfaces[0].traffic.day[] | 
        "\(.date.year)-\(if .date.month < 10 then "0" else "" end)\(.date.month)-\(if .date.day < 10 then "0" else "" end)\(.date.day)  \((.rx/1000000)|floor)  \((.tx/1000000)|floor)  \(((.rx+.tx)/1000000)|floor)"
    ' | head -n 30 | while read -r line; do
        printf "%-12s %12s %12s %12s\n" $line
    done
    
    echo ""
}

cmd_stats_monthly() {
    print_header "每月流量统计 - $INTERFACE"
    
    printf "%-12s %12s %12s %12s\n" "月份" "流入(MB)" "流出(MB)" "总计(MB)"
    echo "────────────────────────────────────────────────────"
    
    vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '
        .interfaces[0].traffic.month[] | 
        "\(.date.year)-\(if .date.month < 10 then "0" else "" end)\(.date.month)  \((.rx/1000000)|floor)  \((.tx/1000000)|floor)  \(((.rx+.tx)/1000000)|floor)"
    ' | while read -r line; do
        printf "%-12s %12s %12s %12s\n" $line
    done
    
    echo ""
}

cmd_stats_hourly() {
    print_header "小时流量统计 - $INTERFACE (最近24小时)"
    
    printf "%-8s %12s %12s %12s\n" "时间" "流入(MB)" "流出(MB)" "总计(MB)"
    echo "──────────────────────────────────────────────────"
    
    vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '
        .interfaces[0].traffic.hour[] | 
        "\(if .hour < 10 then "0" else "" end)\(.hour):00  \((.rx/1000000)|floor)  \((.tx/1000000)|floor)  \(((.rx+.tx)/1000000)|floor)"
    ' | tail -n 24 | while read -r line; do
        printf "%-8s %12s %12s %12s\n" $line
    done
    
    echo ""
}

cmd_stats_detail() {
    print_header "详细流量分析 - $INTERFACE"
    
    # 综合统计
    cmd_stats_summary
    
    # 最近7天趋势
    echo -e "${CYAN}最近7天趋势:${NC}"
    vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '
        .interfaces[0].traffic.day[] | 
        "\(.date.year)-\(if .date.month < 10 then "0" else "" end)\(.date.month)-\(if .date.day < 10 then "0" else "" end)\(.date.day): ↑ \((.tx/1000000)|floor) MB"
    ' | head -n 7
    
    echo ""
    
    # Top 10 流量日
    echo -e "${CYAN}流量使用Top 10:${NC}"
    vnstat -i "$INTERFACE" -t 10 2>/dev/null | grep -v "^$" | tail -n +3
    
    echo ""
}

cmd_stats_export() {
    local export_file="traffic-stats-$(date +%Y%m%d-%H%M%S).csv"
    
    print_info "导出流量数据到: $export_file"
    
    # CSV 头部
    echo "日期,流入(MB),流出(MB),总计(MB)" > "$export_file"
    
    # 导出数据
    vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '
        .interfaces[0].traffic.day[] | 
        "\(.date.year)-\(if .date.month < 10 then "0" else "" end)\(.date.month)-\(if .date.day < 10 then "0" else "" end)\(.date.day),\((.rx/1000000)|floor),\((.tx/1000000)|floor),\(((.rx+.tx)/1000000)|floor)"
    ' >> "$export_file"
    
    print_success "数据已导出到: $export_file"
    print_info "总共 $(wc -l < "$export_file") 行数据"
}

#================================================================
# 系统健康检查
#================================================================

cmd_doctor() {
    print_header "系统健康检查"
    
    local issues=0
    
    # 检查 vnstat 服务
    echo -n "检查 vnstat 服务... "
    if command -v systemctl &> /dev/null; then
        if systemctl is-active vnstat &>/dev/null; then
            print_success "运行中"
        elif pgrep vnstatd &>/dev/null; then
            print_success "运行中 (守护进程)"
        else
            print_error "未运行"
            echo "  修复: sudo systemctl start vnstat"
            issues=$((issues + 1))
        fi
    elif pgrep vnstatd &>/dev/null; then
        print_success "运行中 (守护进程)"
    else
        print_error "未运行"
        echo "  修复: sudo vnstatd -d"
        issues=$((issues + 1))
    fi
    
    # 检查 iptables
    echo -n "检查 iptables... "
    if command -v iptables &> /dev/null; then
        print_success "可用"
    else
        print_error "未安装"
        issues=$((issues + 1))
    fi
    
    # 检查 cron 任务
    echo -n "检查 Cron 任务... "
    if crontab -l 2>/dev/null | grep -q "tx-monitor.sh"; then
        print_success "已配置"
        local interval=$(crontab -l 2>/dev/null | grep "tx-monitor.sh" | awk -F'/' '{print $2}' | awk '{print $1}')
        echo "  间隔: 每 ${interval:-10} 分钟"
    else
        print_warning "未配置"
        echo "  建议: 重新运行 install.sh"
        issues=$((issues + 1))
    fi
    
    # 检查配置文件
    echo -n "检查配置文件... "
    if [ -f "$CONFIG_FILE" ]; then
        print_success "存在"
        source "$CONFIG_FILE"
        echo "  网卡: $INTERFACE"
        echo "  阈值: ${THRESHOLD_MB} MB"
    else
        print_error "不存在"
        issues=$((issues + 1))
    fi
    
    # 检查网卡状态
    if [ -n "$INTERFACE" ]; then
        echo -n "检查网卡 $INTERFACE... "
        if ip link show "$INTERFACE" &>/dev/null; then
            if ip link show "$INTERFACE" | grep -q "state UP"; then
                print_success "UP"
            else
                print_warning "DOWN"
                echo "  修复: sudo ip link set $INTERFACE up"
                issues=$((issues + 1))
            fi
        else
            print_error "不存在"
            issues=$((issues + 1))
        fi
    fi
    
    # 检查监控状态
    echo -n "检查监控状态... "
    if [ -f "$ENABLE_FLAG" ]; then
        print_success "已启用"
    else
        print_info "已禁用"
        echo "  启用: sudo tx-ctl enable"
    fi
    
    # 检查阻断状态
    echo -n "检查阻断状态... "
    if [ -f "$HARD_BLOCK_FLAG" ]; then
        print_warning "硬阻断激活"
        echo "  解除: sudo tx-ctl unblock"
    elif [ -f "$SOFT_BLOCK_FLAG" ]; then
        print_warning "软阻断激活"
        echo "  解除: sudo tx-ctl unblock"
    else
        print_success "正常"
    fi
    
    # 检查防火墙规则
    echo -n "检查防火墙规则... "
    if iptables -L "$IPTABLES_CHAIN" -n &>/dev/null; then
        local rule_count=$(iptables -L "$IPTABLES_CHAIN" -n | grep -c "^[A-Z]")
        print_warning "${rule_count} 条规则激活"
        echo "  清除: sudo tx-ctl rules clear"
    else
        print_success "无激活规则"
    fi
    
    # 检查磁盘空间
    echo -n "检查磁盘空间... "
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ "$disk_usage" -lt 80 ]; then
        print_success "${disk_usage}%"
    elif [ "$disk_usage" -lt 90 ]; then
        print_warning "${disk_usage}%"
    else
        print_error "${disk_usage}% (建议清理)"
        issues=$((issues + 1))
    fi
    
    # 检查日志大小
    echo -n "检查日志大小... "
    if [ -f "$LOG_FILE" ]; then
        local log_size=$(du -m "$LOG_FILE" | cut -f1)
        if [ "$log_size" -lt 50 ]; then
            print_success "${log_size} MB"
        elif [ "$log_size" -lt 100 ]; then
            print_warning "${log_size} MB"
        else
            print_warning "${log_size} MB (建议轮转)"
        fi
    else
        print_info "不存在"
    fi
    
    # 检查 vnstat 数据
    if [ -n "$INTERFACE" ]; then
        echo -n "检查 vnstat 数据... "
        local tx_bytes=$(vnstat -i "$INTERFACE" --json 2>/dev/null | jq -r '.interfaces[0].traffic.month[0].tx' 2>/dev/null)
        if [ -n "$tx_bytes" ] && [[ "$tx_bytes" =~ ^[0-9]+$ ]]; then
            print_success "正常"
        else
            print_warning "数据不可用"
            echo "  等待数据收集或重启 vnstat 服务"
            issues=$((issues + 1))
        fi
    fi
    
    # 总结
    echo ""
    echo "────────────────────────────────────────"
    if [ "$issues" -eq 0 ]; then
        print_success "系统健康状态: 良好"
    elif [ "$issues" -le 2 ]; then
        print_warning "系统健康状态: 一般 (发现 $issues 个问题)"
    else
        print_error "系统健康状态: 需要关注 (发现 $issues 个问题)"
    fi
    echo ""
}

#================================================================
# 帮助信息
#================================================================

cmd_help() {
    cat <<EOF
超流量保护系统 - 管理工具
Traffic Limit Protection System Control Tool

用法:
  tx-ctl <命令> [参数]

命令:
  enable                  启用流量监控
  disable                 禁用流量监控
  status                  查看当前状态和流量统计
  
  unblock                 解除所有流量阻断
  force-check             强制立即执行检查
  test                    测试运行 (不执行实际动作)
  
  stats [类型]            流量统计分析
    summary               综合统计 (默认)
    daily                 每日流量统计
    monthly               每月流量统计
    hourly                小时流量统计
    detail                详细分析
    export                导出CSV数据
  
  logs [lines]            查看日志 (默认50行)
  reset                   重置月度流量统计
  config                  编辑配置文件
  
  set-threshold <MB>      快速设置流量阈值
  
  rules show              显示当前防火墙规则
  rules clear             清除监控相关防火墙规则
  
  doctor                  系统健康检查
  help                    显示此帮助信息
  version                 显示版本信息

示例:
  sudo tx-ctl enable              # 启用监控
  sudo tx-ctl status              # 查看状态
  sudo tx-ctl stats               # 查看流量统计
  sudo tx-ctl stats daily         # 查看每日流量
  sudo tx-ctl stats export        # 导出数据
  sudo tx-ctl doctor              # 健康检查
  sudo tx-ctl logs 100            # 查看最近100行日志
  sudo tx-ctl set-threshold 30000 # 设置阈值为30GB
  sudo tx-ctl unblock             # 解除阻断

配置文件: $CONFIG_FILE
日志文件: $LOG_FILE

EOF
}

#================================================================
# 版本信息
#================================================================

cmd_version() {
    echo "超流量保护系统 v1.0.0"
    echo "Traffic Limit Protection System"
    echo "Copyright (c) 2026"
}

#================================================================
# 主函数
#================================================================

main() {
    local cmd="${1:-help}"
    shift || true
    
    case "$cmd" in
        enable)
            cmd_enable
            ;;
        disable)
            cmd_disable
            ;;
        status)
            cmd_status
            ;;
        stats)
            cmd_stats "$@"
            ;;
        unblock)
            cmd_unblock
            ;;
        logs)
            cmd_logs "$@"
            ;;
        force-check)
            cmd_force_check
            ;;
        test)
            cmd_test
            ;;
        reset)
            cmd_reset
            ;;
        config)
            cmd_config
            ;;
        set-threshold)
            cmd_set_threshold "$@"
            ;;
        doctor)
            cmd_doctor
            ;;
        rules)
            case "${1:-show}" in
                show)
                    cmd_rules_show
                    ;;
                clear)
                    cmd_rules_clear
                    ;;
                *)
                    print_error "未知的规则命令: $1"
                    echo "可用命令: show, clear"
                    exit 1
                    ;;
            esac
            ;;
        help|-h|--help)
            cmd_help
            ;;
        version|-v|--version)
            cmd_version
            ;;
        *)
            print_error "未知命令: $cmd"
            echo "运行 'tx-ctl help' 查看帮助"
            exit 1
            ;;
    esac
}

# 运行主函数
main "$@"
